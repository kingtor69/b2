#include <shared/system.h>
#include <shared/debug.h>
#include <shared/log.h>
#include <beeb/PCD8572.h>

#include <shared/enum_def.h>
#include <beeb/PCD8572.inl>
#include <shared/enum_end.h>

//////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////

LOG_TAGGED_DEFINE(EEPROM, "nvram", "EEPROM", &log_printer_stdout_and_debugger, true);

//////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////

// https://github.com/stardot/b-em/blob/master/src/compactcmos.c

// https://github.com/bitshifters/bbc-documents/blob/master/ICs/PCD8572%201%20Kbit%20EEPROM/PCD8572-Microchip.pdf

//////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////

#if BBCMICRO_TRACE
void SetPCD8572Trace(PCD8572 *p, Trace *t) {
    p->t = t;
}
#endif

//////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////

bool UpdatePCD8572(PCD8572 *p, bool clk, bool data) {
    const bool start = p->oclk && clk && p->odata && !data;
    const bool stop = p->oclk && clk && !p->odata && data;
    const bool clkup = !p->oclk && clk;
    const int bit = clkup ? data : -1;

    LOGF(EEPROM, "clk=%d data=%d: start=%d stop=%d clkup=%d bit=%d\n", clk, data, start, stop, clkup, bit);

    p->oclk = clk;
    p->odata = data;

    return data;
}

//////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////
